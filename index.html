<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>軍儀風ボードゲーム</title>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; }
    h1 { margin-top: 20px; }
    #gameBoard { display: grid; grid-template-columns: repeat(9, 60px); grid-template-rows: repeat(9, 60px); gap: 2px; margin: 20px auto; }
    .cell {
      width: 60px;
      height: 60px;
      background-color: beige;
      border: 1px solid #000;
      position: relative;
      cursor: pointer;
    }
    .piece {
      width: 50px;
      height: 50px;
      border-radius: 5px;
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .black { background-color: black; }
    .white { background-color: gray; }
    #status { font-size: 24px; margin-top: 20px; }
    #restartButton {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>軍儀風ボードゲーム</h1>
  <div id="gameBoard"></div>
  <div id="status">黒の番です</div>
  <button id="restartButton">リスタート</button>
  <script>
    const boardSize = 9;
    let board = Array.from({ length: boardSize }, () => Array(boardSize).fill(null));
    let currentPlayer = 'black';
    let gameOver = false;
    const gameBoard = document.getElementById('gameBoard');
    const statusDisplay = document.getElementById('status');
    const restartButton = document.getElementById('restartButton');

    // 駒の種類と移動パターン
    const pieceTypes = {
      '兵': { moves: [[0,1], [1,0], [0,-1], [-1,0]] },
      '砲': { moves: [[0,2], [2,0], [0,-2], [-2,0]] },
      '将': { moves: [[1,1], [1,-1], [-1,1], [-1,-1]] }
    };

    function initBoard() {
      gameBoard.innerHTML = '';
      for (let row = 0; row < boardSize; row++) {
        for (let col = 0; col < boardSize; col++) {
          const cell = document.createElement('div');
          cell.classList.add('cell');
          cell.dataset.row = row;
          cell.dataset.col = col;
          cell.addEventListener('click', handleClick);
          gameBoard.appendChild(cell);

          // 初期配置
          if (row === 0 && (col === 4)) {
            placePiece(row, col, '将', 'white');
          } else if (row === 8 && (col === 4)) {
            placePiece(row, col, '将', 'black');
          } else if (row === 1 && (col % 2 === 1)) {
            placePiece(row, col, '砲', 'white');
          } else if (row === 7 && (col % 2 === 1)) {
            placePiece(row, col, '砲', 'black');
          } else if (row === 2 && (col % 2 === 0)) {
            placePiece(row, col, '兵', 'white');
          } else if (row === 6 && (col % 2 === 0)) {
            placePiece(row, col, '兵', 'black');
          } else {
            board[row][col] = null;
          }
        }
      }
      currentPlayer = 'black';
      gameOver = false;
      updateStatus();
    }

    function placePiece(row, col, type, player) {
      const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
      const piece = document.createElement('div');
      piece.classList.add('piece', player);
      piece.textContent = type;
      cell.appendChild(piece);
      board[row][col] = { player, type };
    }

    function handleClick(e) {
      if (gameOver) return;
      const cell = e.currentTarget;
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);

      if (board[row][col] && board[row][col].player === currentPlayer) {
        // 駒を選択
        selectPiece(row, col);
      } else if (selectedPiece) {
        // 選択した駒を移動
        movePiece(row, col);
      }
    }

    let selectedPiece = null;

    function selectPiece(row, col) {
      clearSelection();
      const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
      cell.classList.add('selected');
      selectedPiece = { row, col, piece: board[row][col] };
      showValidMoves(row, col);
    }

    function movePiece(newRow, newCol) {
      if (isValidMove(newRow, newCol)) {
        // 駒を移動
        board[newRow][newCol] = selectedPiece.piece;
        board[selectedPiece.row][selectedPiece.col] = null;
        currentPlayer = currentPlayer === 'black' ? 'white' : 'black';
        clearSelection();
        renderBoard();
        updateStatus();
        checkGameOver(newRow, newCol);
      } else {
        alert('その場所には移動できません。');
      }
    }

    function isValidMove(row, col) {
      const piece = selectedPiece.piece;
      const moves = pieceTypes[piece.type].moves;
      for (let [dx, dy] of moves) {
        const newRow = selectedPiece.row + dx;
        const newCol = selectedPiece.col + dy;
        if (newRow === row && newCol === col) {
          if (!board[row][col] || board[row][col].player !== currentPlayer) {
            return true;
          }
        }
      }
      return false;
    }

    function showValidMoves(row, col) {
      const piece = selectedPiece.piece;
      const moves = pieceTypes[piece.type].moves;
      moves.forEach(([dx, dy]) => {
        const newRow = row + dx;
        const newCol = col + dy;
        if (newRow >= 0 && newRow < boardSize && newCol >= 0 && newCol < boardSize) {
          if (!board[newRow][newCol] || board[newRow][newCol].player !== currentPlayer) {
            const cell = document.querySelector(`.cell[data-row='${newRow}'][data-col='${newCol}']`);
            cell.classList.add('valid-move');
          }
        }
      });
    }

    function clearSelection() {
      const selectedCells = document.querySelectorAll('.selected, .valid-move');
      selectedCells.forEach(cell => cell.classList.remove('selected', 'valid-move'));
      selectedPiece = null;
    }

    function renderBoard() {
      for (let row = 0; row < boardSize; row++) {
        for (let col = 0; col < boardSize; col++) {
          const cell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
          cell.innerHTML = '';
          const pieceData = board[row][col];
          if (pieceData) {
            const piece = document.createElement('div');
            piece.classList.add('piece', pieceData.player);
            piece.textContent = pieceData.type || '';
            cell.appendChild(piece);
          }
        }
      }
    }

    function updateStatus() {
      statusDisplay.textContent = gameOver ? 'ゲーム終了' : `${currentPlayer === 'black' ? '黒' : '白'}の番です`;
    }

    function checkGameOver(row, col) {
      // 相手の将を取ったらゲーム終了
      const opponent = currentPlayer === 'black' ? 'white' : 'black';
      let opponentKingExists = false;
      for (let r = 0; r < boardSize; r++) {
        for (let c = 0; c < boardSize; c++) {
          if (board[r][c] && board[r][c].player === opponent && board[r][c].type === '将') {
            opponentKingExists = true;
          }
        }
      }
      if (!opponentKingExists) {
        gameOver = true;
        alert(`${currentPlayer === 'black' ? '白' : '黒'}の勝ちです！`);
        updateStatus();
      }
    }

    restartButton.addEventListener('click', () => {
      initBoard();
    });

    initBoard();
  </script>
</body>
</html>
